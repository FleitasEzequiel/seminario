<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Preguntas y Respuestas Inteligentes</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/qna"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    /* body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; } */
    body{ margin:0}
    /* textarea, input[type="text"] { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; } */
    .resaltado { background-color: yellow; font-weight: bold; }
    #respuesta { font-size: 18px; margin-top: 10px; background: #fff; padding: 10px; border-radius: 5px; }
    #historial { margin-top: 20px; }
    #passage { font-family: monospace; }
    .loading { color: #666; font-style: italic; }
    button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <div class="div1">
      <textarea name="" id="passage">Google LLC is an American multinational technology company that focuses on search engine technology, online advertising, cloud computing, computer software, quantum computing, e-commerce, artificial intelligence, and consumer electronics. It has been referred to as the "most powerful company in the world" and one of the world's most valuable brands due to its market dominance, data collection, and technological advantages in the area of artificial intelligence. Google was founded in 1998 by Larry Page and Sergey Brin while they were Ph.D. students at Stanford University in California.</textarea>
    </div>
    <div class="div2">
      <div class="chat"></div>
      <div class="pregunta">
        <input type="text" name="pregunta" id="question">
        <button type="button" id="buscarBtn" onclick="preguntar()">Preguntar</button>
      </div>
    </div>
  </div>
<style>
  body{
    background-color: #EEEFE0;
  }
  .container{
    margin:0;
    padding: 0;
    display:grid;
    grid-template-columns: 20% 80%;
    width: 100vw;
    height: 100vh;
  }
  div{
    display:flex;
  }
  .div1{
    /* background-color:red; */
    background-color: #EEEFE0;
    border-right:  solid #A7C1A8;
  }
  .div2{
    display:grid;
    grid-template-rows: 80% 20%;
  }
  .pregunta{
    display:flex;
    justify-content: space-around;
  }
  [name="pregunta"]{
    background-color: #D1D8BE;
    width: 50%;
    padding: 10px;
    margin-bottom: 10px;
    border: 2px #A7C1A8 solid;
    outline: 0;
    border-radius: 16px;
    display:flex;
  }
</style>
<!-- <h1>Modelo de Pregunta y Respuesta</h1>

<label for="fileInput">Subir archivo (.txt o .pdf):</label>
<input type="file" id="fileInput" accept=".txt,application/pdf" onchange="leerArchivo(event)">

<label for="passage">Texto:</label>
<textarea id="passage" rows="10" placeholder="Pega aqu√≠ el texto sobre el que quieres hacer preguntas...">Google LLC is an American multinational technology company that focuses on search engine technology, online advertising, cloud computing, computer software, quantum computing, e-commerce, artificial intelligence, and consumer electronics. It has been referred to as the "most powerful company in the world" and one of the world's most valuable brands due to its market dominance, data collection, and technological advantages in the area of artificial intelligence. Google was founded in 1998 by Larry Page and Sergey Brin while they were Ph.D. students at Stanford University in California.</textarea>

<label for="question">Pregunta (en espa√±ol):</label>
<input type="text" id="question" placeholder="¬øQui√©n fund√≥ Google?" onkeypress="if(event.key==='Enter') preguntar()">

<button id="buscarBtn" onclick="preguntar()">Buscar respuesta</button>

<div id="respuesta">Respuesta: <span class="loading">Cargando modelo...</span></div>

<div id="historial">
  <h3>Historial:</h3>
  <ul id="listaHistorial"></ul>
</div> -->
<script src="env.js"></script>
<script>
let model;
let modeloCargado = false;
const passageTextarea = document.getElementById("passage");
// const respuestaDiv = document.getElementById("respuesta");
// const listaHistorial = document.getElementById("listaHistorial");
const buscarBtn = document.getElementById("buscarBtn");
console.log("Ac√°",API_KEY)
async function cargarModelo() {
  try {
    console.log("Cargando modelo...");
    model = await qna.load();
    modeloCargado = true;
    console.log("Modelo cargado exitosamente");
    // respuestaDiv.innerHTML = "Respuesta: <em>Modelo cargado. Haz una pregunta para comenzar.</em>";
    buscarBtn.disabled = false;
  } catch (error) {
    console.error("Error al cargar el modelo:", error);
    // respuestaDiv.innerHTML = "Error al cargar el modelo. Recarga la p√°gina.";
  }
}

// Inicializar
buscarBtn.disabled = true;
cargarModelo();

// Traducci√≥n autom√°tica usando LibreTranslate
async function traducir(texto, desde = "es", a = "en") {
  try {
    const response = await fetch("https://translation.googleapis.com/language/translate/v2", {
      method: "POST",
      headers: { "Content-Type": "application/json",
        "x-goog-api-key": API_KEY
       },
      body: JSON.stringify({
        q: texto,
        source:desde,
        target: a,
        format: "text"
      })
    });

    if (!response.ok) {
      throw new Error(`Error de traducci√≥n: ${response.status}`);
    }
    
    const data = await response.json();
    return data.data.translations[0].translatedText || texto; // Fallback al texto original si falla
  } catch (error) {
    console.warn("Error en traducci√≥n, usando texto original:", error);
    return texto; // Usa el texto original si falla la traducci√≥n
  }
}

// Lectura por voz
function leerTexto(texto) {
  try {
    if ('speechSynthesis' in window) {
      const msg = new SpeechSynthesisUtterance(texto);
      msg.lang = "es-ES";
      msg.rate = 0.8;
      window.speechSynthesis.speak(msg);
    }
  } catch (error) {
    console.warn("Error en s√≠ntesis de voz:", error);
  }
}

// Historial
function agregarHistorial(pregunta, respuesta) {
  const item = document.createElement("li");
  item.innerHTML = `<strong> ${pregunta}</strong><br> ${respuesta}`;
  item.style.marginBottom = "10px";
  listaHistorial.insertBefore(item, listaHistorial.firstChild); // Agrega al inicio
}

// pesaltado en el texto 
function resaltarTexto(textoRespuesta) {
  const contenido = passageTextarea.textContent;
  
  // para  caracteres especiales para regex
  const textoEscapado = textoRespuesta.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  
  // Crea nueva regex
  const regex = new RegExp(`(${textoEscapado})`, "gi");
  
  // un div temporal para mostrar el texto resaltado
  const divResaltado = document.createElement("div");
  divResaltado.innerHTML = contenido.replace(regex, '<span class="resaltado">$1</span>');
  divResaltado.style.cssText = "margin-top: 10px; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 5px;";
  
  // Remueve el resaltado anterior si existe
  const resaltadoAnterior = document.getElementById("textoResaltado");
  if (resaltadoAnterior) {
    resaltadoAnterior.remove();
  }
  
  divResaltado.id = "textoResaltado";
  divResaltado.innerHTML = "<strong>üìç Texto con respuesta resaltada:</strong><br>" + divResaltado.innerHTML;
  
  // Inserta despu√©s del textarea
  passageTextarea.parentNode.insertBefore(divResaltado, passageTextarea.nextSibling);
}

async function preguntar() {
  const passage = passageTextarea.value.trim();
  const preguntaES = document.getElementById("question").value.trim();

  // if (!modeloCargado) {
  //   respuestaDiv.textContent = "El modelo a√∫n se est√° cargando, espera un momento...";
  //   return;
  // }

  // if (!preguntaES) {
  //   respuestaDiv.textContent = "Por favor escribe una pregunta.";
  //   return;
  // }

  // if (!passage) {
  //   respuestaDiv.textContent = " Por favor proporciona un texto para analizar.";
  //   return;
  // }

  try {
    buscarBtn.disabled = true;
    // respuestaDiv.innerHTML = "Buscando respuesta...";

    // Traduce pregunta al ingl√©s
    const preguntaEN = await traducir(preguntaES, "es", "en");
    console.log("Pregunta traducida al ingl√©s:", preguntaEN);
    // passageES = await traducir(passage)
    // console.log("passage espa√±ol:",passageES)

    //Traducir el contexto a ingl√©s
    const passageEN = await traducir(passage,"auto","en")
    // Obtenie respuestas del modelo
    const answers = await model.findAnswers(preguntaEN, passageEN);
    console.log("Respuestas encontradas:", answers);

    if (answers && answers.length > 0 && answers[0].score > 0.1) {
      const respuestaEN = answers[0].text;
      const confianza = Math.round(answers[0].score * 100);
      
      // Traduce la respuesta al espa√±ol
      const respuestaES = await traducir(respuestaEN, "en", "es");

      // respuestaDiv.innerHTML = ` <strong>Respuesta:</strong> ${respuestaES}<br><small>Confianza: ${confianza}%</small>`;
      
      // Leerespuesta en voz alta
      leerTexto(respuestaES);
      
      // Agrega al historial
      // agregarHistorial(preguntaES, respuestaES);
      
      // Resalta texto en el documento
      // resaltarTexto(respuestaEN);
      
      // Limpia la pregunta
      document.getElementById("question").value = "";
      
    } else {
      console.log("no se encontr√≥ una respuesta")
      // respuestaDiv.innerHTML = "No se encontr√≥ una respuesta adecuada en el texto proporcionado.";
    }
  } catch (error) {
    console.error("Error al procesar pregunta:", error);
    // respuestaDiv.innerHTML = "Error al procesar la pregunta. Int√©ntalo de nuevo.";
    console.log("Error al procesar la pregunta. Int√©ntalo de nuevo.")
  } finally {
    buscarBtn.disabled = false;
  }
}

// * Lectura de archivo 
async function leerArchivo(event) {
  const archivo = event.target.files[0];
  if (!archivo) return;

  try {
    if (archivo.type === "text/plain") {
      const texto = await archivo.text();
      passageTextarea.value = texto;
      respuestaDiv.innerHTML = "Archivo de texto cargado correctamente.";
      
    } else if (archivo.type === "application/pdf") {
      respuestaDiv.innerHTML = "Procesando PDF...";
      
      const reader = new FileReader();
      reader.onload = async function () {
        try {
          const typedarray = new Uint8Array(reader.result);
          
          // Configura PDF.js
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
          
          const pdf = await pdfjsLib.getDocument(typedarray).promise;
          let textoCompleto = "";
          
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            const textItems = content.items.map(item => item.str).join(" ");
            textoCompleto += textItems + "\n\n";
          }
          
          passageTextarea.value = textoCompleto.trim();
          respuestaDiv.innerHTML = `PDF procesado correctamente. ${pdf.numPages} p√°ginas le√≠das.`;
          
        } catch (error) {
          console.error("Error al procesar PDF:", error);
          respuestaDiv.innerHTML = "Error al procesar el PDF.";
        }
      };
      reader.readAsArrayBuffer(archivo);
      
    } else {
      alert("Formato no soportado. Solo se permiten archivos .txt o .pdf");
    }
  } catch (error) {
    console.error("Error al leer archivo:", error);
    respuestaDiv.innerHTML = "Error al leer el archivo.";
  }
}
</script>
</body>
</html>